<%# :page_heading 見出し %>
<%# :url フォーム送信先URL %>
<%# :button_text submitボタンのテキスト%>
<%# :form_id form要素のid %>

<%= form_for @resume, url: yield(:url) do |f| %>
<div class="py-3">
  <div class="container">
    <h2 class="heading">
      <%= yield(:page_heading) %>
    </h2>
    <p>ここではツイートの際に表示する画像、ツイートのリンク先ページを同時に作成します</p>
    <div class="row">
      <div class="input-wrapper p-4 col-lg-5">
        
        <%= f.label :job_type, '職種' %>
        <%= f.check_box :job_type_chk, {class:'d-inline-block'} , true , false %>
        <%= f.text_field :job_type, class: 'form-control', placeholder: '例：Webエンジニア, フロントエンドエンジニア...' %>
        <%= f.label :location, '勤務地' ,class:"mt-2" %>
        <%= f.check_box :location_chk, {class:'d-inline-block'} , true , false %>
        <%= f.text_field :location, class: 'form-control', placeholder: '大阪、東京' %>
        <%= f.label :desired_salary, '年収' %>
        <%= f.check_box :desired_salary_chk, {class:'d-inline-block'} , true , false %>
        <%= f.text_field :desired_salary, class: 'form-control', placeholder: '500万以上' %>
        <%= f.label :age, '年齢' ,class:"mt-2" %>
        <%= f.check_box :age_chk, {class:'d-inline-block'} , true , false %>
        <%= f.text_field :age, class: 'form-control', placeholder: '30代' %>
        <%= f.label :skills, 'スキル' ,class:"mt-2" %>
        <%= f.check_box :skills_chk, {class:'d-inline-block'} , true , false %>
        <%= f.text_field :skills, class: 'form-control', placeholder: 'HTML/CSS, Ruby, Ruby on Rails' %>
        <%= f.label :timing, '転職時期' ,class:"mt-2" %>
        <%= f.check_box :timing_chk, {class:'d-inline-block'} , true , false %>
        <%= f.text_field :timing, class: 'form-control', placeholder: '3ヶ月後' %>
        <%= f.label :capacity, '資格' ,class:"mt-2" %>
        <%= f.check_box :capacity_chk, {class:'d-inline-block'} , true , false %>
        <%= f.text_field :capacity, class: 'form-control', placeholder: '基本情報技術者, 応用情報技術者' %>
        <%= f.label :languages, '言語' ,class:"mt-2" %>
        <%= f.check_box :languages_chk, {class:'d-inline-block'} , true , false %>
        <%= f.text_field :languages, class: 'form-control', placeholder: '日本語, 英語, 中国語' %>
        <%= f.label :employment_pattern, '雇用形態' ,class:"mt-2" %>
        <%= f.check_box :employment_pattern_chk, {class:'d-inline-block'} , true , false %>
        <%= f.text_field :employment_pattern, class: 'form-control', placeholder: '正社員, 契約社員' %>
        <%= f.label :note, '備考' ,class:"mt-2" %>
        <%= f.check_box :note_chk, {class:'d-inline-block'} , true , false %>
        <%= f.text_area :note, class: 'form-control', rows: '10', placeholder: "その他要望, 追記事項等あれば...\r\n完全週休２日制、SES以外, リモート可優先..." %>
        <%= f.hidden_field :image %>  <%# html2canvasで生成した画像のbase64でエンコードしたデータを入れる %>
      </div>

      <div class="col-lg-7 sm-hidden">
        <%# twesume %>
        <div class="twesume-wrapper sticky">
          <div class="text-center">
            <p class="text-muted d-none d-md-block">こちらがツイート時に表示される画像です</p>
          </div>
          <div id="twesume" class="shadow">
            <div class="twesume-title p-2">TWESU<strong>ME</strong> CARD</div>
            <div class="twesume-container">
              <div class="twesume-element">
                <p id="label-job_type" class="twesume-label">職種</p>
                <p id="item-job_type" class="twesume-item"></p>
              </div>
              <div class="twesume-element">
                <p id="label-location" class="twesume-label">勤務地</p>
                <p id="item-location" class="twesume-item"></p>
              </div>
              <div class="twesume-element">
                <p id="label-desired_salary" class="twesume-label">年収</p>
                <p id="item-desired_salary" class="twesume-item"></p>
              </div>
              <div class="twesume-element">
                <p id="label-age" class="twesume-label">年齢</p>
                <p id="item-age" class="twesume-item"></p>
              </div>
              <div class="twesume-element">
                <p id="label-skills" class="twesume-label">スキル</p>
                <p id="item-skills" class="twesume-item"></p>
              </div>
              <div class="twesume-element">
                <p id="label-timing" class="twesume-label">転職時期</p>
                <p id="item-timing" class="twesume-item"></p>
              </div>
              <div class="twesume-element">
                <p id="label-capacity" class="twesume-label">資格</p>
                <p id="item-capacity" class="twesume-item"></p>
              </div>
              <div class="twesume-element">
                <p id="label-languages" class="twesume-label">言語</p>
                <p id="item-languages" class="twesume-item"></p>
              </div>
              <div class="twesume-element">
                <p id="label-employment_pattern" class="twesume-label">雇用形態</p>
                <p id="item-employment_pattern" class="twesume-item"></p>
              </div>
              <div class="twesume-element">
                <p id="label-note" class="twesume-label">備考</p>
                <p id="item-note" class="twesume-item"></p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row">
  <div class="container">
    <div class="input-wrapper col-lg-12">
      <%= f.label :note, '自己PR' ,class:"mt-2" %>
      <%= f.text_area :comment, class: 'form-control', rows: '10', placeholder: 'こちらの内容はカード内には記載されませんが、TWESUMEページの自己PR欄に記載されます' %>
    </div>
  </div>
</div>


<!-- 切り替えボタンの設定 -->
<div class="mt-4 mb-5">
  <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#exampleModalCenter" onclick="createImage()">
    カード生成
  </button>
</div>

<!-- モーダルの設定 -->
<div class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle"
  aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalCenterTitle">画像生成完了</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="閉じる">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div id="download">
          <img id="canvas" class="img-fluid">
        </div>
      </div>
      <div class="modal-footer">
        <%= button_tag type:"button", class: 'btn btn-primary ml-auto' ,id: 'form-submit' do %>
        <%= fa_icon 'id-card', text: yield(:button_text) %>
        <% end %>
      </div>
    </div>
  </div>
</div>
<% end %>

<div id="loading" class="backdrop">
  <div class="lds-spinner">
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
  </div>
  <p class="text-white spinner-text">画像を送信しています...<br>しばらくお待ちください</p>

</div>

<script>
  $(document).on('turbolinks:load', function () {
    //=====ページ読み込み時の処理======
    //編集の場合、以前の入力内容をカードに適用
    $('input[id^="resume_"]').each(function () {
      var item_id = $(this).attr("id").replace('resume_', 'item-');
      $('#' + item_id).text($(this).val());
    });

    $('#item-note').html($('#resume_note').val().replace(/\r|\n|\r\n/g, '<br>'));

    // 読み込み時のcheckboxの状態でカード上の表示非表示を切替
    $('input[id$="_chk"]').each(function () {
      var item_id = $(this).attr("id").replace('resume_', 'item-').replace('_chk', '');
      //alert(item_id);
      if ($(this).prop('checked')) { //チェックされている場合
        $('#' + item_id).parent().show(); //表示
      } else { //チェックが無い場合
        $('#' + item_id).parent().hide(); //非表示
      };
    });

    //=====inputに変更があった時の処理======
    $('input[id^="resume_"]').on('change input keyup', function () {
      var item_id = $(this).attr("id").replace('resume_', 'item-');
      //alert(item_id);
      $('#' + item_id).text($(this).val());
    });

    //noteはinputではなくtextareaなので別で実装
    $('#resume_note').on('change input keyup', function () {
      //alert($(this).val());
      $('#item-note').html($(this).val().replace(/\r|\n|\r\n/g, '<br>'));
    });

    // checkboxでカード上の表示非表示を切替
    $('input[id$="_chk"]').on('change input', function () {
      var item_id = $(this).attr("id").replace('resume_', 'item-').replace('_chk', '');
      //alert(item_id);

      if ($(this).prop('checked')) { //チェックされている場合
        $('#' + item_id).parent().show(); //表示
      } else { //チェックが無い場合
        $('#' + item_id).parent().hide(); //非表示
      };
    }).change();

    //カード画像生成
    document.createImage = () => {
      const twesumeElement = document.querySelector('#twesume'); //カードの要素取得
      const canvasElement = document.querySelector('#canvas'); //生成画像配置要素取得
      html2canvas(twesumeElement).then(canvas => { //#twesumeをcanvasに画像として生成
        canvasElement.src = canvas.toDataURL();     //生成した画像を#canvasに表示
        $('#resume_image').val(canvas.toDataURL()); //imageにbase64のデータを格納
      });
    };

    //投稿ボタンの処理
    $('#form-submit').click(function () {
      //二重投稿できないようにボタンを無効
      $(this).prop("disabled",true);

      //ロード画面表示
      $('#loading').show();

      $("#<%=yield(:form_id)%>").submit();  //submit

    });

  });
</script>